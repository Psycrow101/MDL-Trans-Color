function textureHeader(){this.name=null,this.flags=null,this.width=null,this.height=null,this.index=null}function color(){this.r=0,this.g=0,this.b=0}function errorHandler(e){switch(e.target.error.code){case e.target.error.NOT_FOUND_ERR:alert("File Not Found!");break;case e.target.error.NOT_READABLE_ERR:alert("File is not readable");break;case e.target.error.ABORT_ERR:break;default:alert("An error occurred reading this file.")}}function handleFileSelect(e){fileName=e.target.files[0].name+e.target.files[0].type;var t=new FileReader;t.onerror=errorHandler,t.onload=function(e){if(data=t.result,dv=new DataView(data,0),1229214548!=dv.getUint32(0))return void alert("Unknown version of studio model");if(10!=dv.getUint8(4))return void alert("Unknown version of Half-Life studio model");var a=dv.getUint32(180,1),n=dv.getUint32(184,1);textureInfo=new Array(a),pixelIndex=new Array(a),pixelPallate=new Array(a),flagOffset=new Array(a);for(var i=0;a>i;i++)textureInfo[i]=new textureHeader,n+=64,textureInfo[i].flags=dv.getUint32(n,1),flagOffset[i]=n,n+=4,textureInfo[i].width=dv.getUint32(n,1),n+=4,textureInfo[i].height=dv.getUint32(n,1),n+=4,textureInfo[i].index=dv.getUint32(n,1),n+=4;for(var i=0;a>i;i++){var r=textureInfo[i].index;pixelIndex[i]=new Array(textureInfo[i].width*textureInfo[i].height);for(var l=0;l<textureInfo[i].width*textureInfo[i].height;l++)pixelIndex[i][l]=dv.getUint8(r++);pixelPallate[i]=new Array(256);for(var l=0;256>l;l++)pixelPallate[i][l]=new color,pixelPallate[i][l].r=dv.getUint8(r++),pixelPallate[i][l].g=dv.getUint8(r++),pixelPallate[i][l].b=dv.getUint8(r++);var d=document.createElement("canvas");d.id=i,d.width=textureInfo[i].width,d.height=textureInfo[i].height;for(var o=d.getContext("2d"),x=o.createImageData(textureInfo[i].width,textureInfo[i].height),l=0,f=0;l<x.data.length;l+=4,f++)x.data[l]=pixelPallate[i][pixelIndex[i][f]].r,x.data[l+1]=pixelPallate[i][pixelIndex[i][f]].g,x.data[l+2]=pixelPallate[i][pixelIndex[i][f]].b,x.data[l+3]=64==textureInfo[i].flags&&255==pixelIndex[i][f]?0:255;o.putImageData(x,0,0),$("#textures").append(d),$("#textures").append("<hr>"),d.onclick=function(e){var t=findPos(this),a=e.pageX-t.x,n=e.pageY-t.y,i=this.id,r=n*textureInfo[i].width+a,d=pixelIndex[i][r];if(255!=d){var o=this.getContext("2d"),x=o.getImageData(0,0,textureInfo[i].width,textureInfo[i].height);if(e.altKey){var f=pixelPallate[i][d];pixelPallate[i][d]=pixelPallate[i][255],pixelPallate[i][255]=f;var u=textureInfo[i].index+textureInfo[i].width*textureInfo[i].height;for(dv.setUint8(u+3*d,pixelPallate[i][d].r),dv.setUint8(u+3*d+1,pixelPallate[i][d].g),dv.setUint8(u+3*d+2,pixelPallate[i][d].b),dv.setUint8(u+765,pixelPallate[i][255].r),dv.setUint8(u+765+1,pixelPallate[i][255].g),dv.setUint8(u+765+2,pixelPallate[i][255].b),l=0;l<textureInfo[i].width*textureInfo[i].height;l++)pixelIndex[i][l]==d?(pixelIndex[i][l]=255,dv.setUint8(textureInfo[i].index+l,255),x.data[4*l+3]=0):255==pixelIndex[i][l]&&(pixelIndex[i][l]=d,dv.setUint8(textureInfo[i].index+l,d),x.data[4*l]=pixelPallate[i][d].r,x.data[4*l+1]=pixelPallate[i][d].g,x.data[4*l+2]=pixelPallate[i][d].b,x.data[4*l+3]=255)}else for(l=0;l<textureInfo[i].width*textureInfo[i].height;l++)pixelIndex[i][l]==d&&(dv.setUint8(textureInfo[i].index+l,255),x.data[4*l+3]=0);dv.setUint32(flagOffset[i],64,1),o.putImageData(x,0,0)}},d.oncontextmenu=function(e){e.preventDefault();var t=findPos(this),a=e.pageX-t.x,n=e.pageY-t.y,i=this.id,r=n*textureInfo[i].width+a,d=pixelIndex[i][r];if(255!=d){var o=this.getContext("2d"),x=o.getImageData(0,0,textureInfo[i].width,textureInfo[i].height);for(l=0;l<textureInfo[i].width*textureInfo[i].height;l++)pixelIndex[i][l]==d&&(dv.setUint8(textureInfo[i].index+l,d),x.data[4*l]=pixelPallate[i][d].r,x.data[4*l+1]=pixelPallate[i][d].g,x.data[4*l+2]=pixelPallate[i][d].b,x.data[4*l+3]=255);o.putImageData(x,0,0)}}}$("#file").remove(),$("#menu").append('<input type="button" onclick="save_file()" value="Save"/>'),$("#menu").append('<div id="control-info"><b>Left-click:</b> transparent | <b>Right-click:</b> untransparent | <b>Alt+left-click:</b> to swap with transparent color</div>')},t.readAsArrayBuffer(e.target.files[0])}function save_file(){var e=$("#saver"),t=new Blob([data],{type:"octet/stream"}),a=window.URL.createObjectURL(t);e.attr("href",a),e.attr("download",fileName),jQuery("#saver")[0].click(),window.URL.revokeObjectURL(a)}function findPos(e){var t=0,a=0;if(e.offsetParent){do t+=e.offsetLeft,a+=e.offsetTop;while(e=e.offsetParent);return{x:t,y:a}}return void 0}var fileName,data,dv,textureInfo,pixelIndex,pixelPallate,flagOffset,lastColor;$(document).ready(function(){$("#file").on("change",handleFileSelect)});